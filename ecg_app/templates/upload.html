{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ECG Analyzer - Advanced Cardiac Analysis</title>
    <link rel="stylesheet" href="{% static 'ecg_app/css/styles.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ef-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
        }
        
        .ef-normal {
            color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6, #27ae60);
        }
        
        .ef-borderline {
            color: #f39c12;
            background: linear-gradient(135deg, #ffeaa7, #f39c12);
        }
        
        .ef-abnormal {
            color: #e74c3c;
            background: linear-gradient(135deg, #fab1a0, #e74c3c);
        }
        
        .confidence-bar {
            width: 100%;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            height: 25px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            text-align: center;
            line-height: 25px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            transition: width 0.5s ease;
        }
        
        .echo-result-section {
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #ff6b6b;
            background: white;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .echo-recommendations {
            background: linear-gradient(135deg, #e8f8f5, #d1f2eb);
            border-left: 4px solid #27ae60;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
        }
        
        .echo-recommendations ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .echo-recommendations li {
            margin: 8px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <h1><i class="fas fa-heartbeat"></i> AI ECG Analyzer</h1>
            <p class="subtitle">Advanced Artificial Intelligence for Cardiac Analysis</p>
        </header>

        <!-- Navigation Bar -->
        <div class="main-card" style="margin-bottom: 20px;">
            <div class="upload-section" style="padding: 15px 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <a href="{% url 'home' %}" class="upload-btn" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); text-decoration: none; margin-right: 10px;">
                            <i class="fas fa-chart-line"></i> ECG Analysis
                        </a>
                        <a href="{% url 'upload_echo' %}" class="upload-btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); text-decoration: none; margin-right: 10px;">
                            <i class="fas fa-heart"></i> Echo Analysis
                        </a>
                        <a href="{% url 'uploaded_files' %}" class="upload-btn" style="background: linear-gradient(135deg, #6c757d, #5a6268); text-decoration: none; margin-right: 10px;">
                            <i class="fas fa-folder"></i> ECG Files
                        </a>
                        <a href="{% url 'echo_files_list' %}" class="upload-btn" style="background: linear-gradient(135deg, #74b9ff, #0984e3); text-decoration: none;">
                            <i class="fas fa-video"></i> Echo Files
                        </a>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="color: var(--text-dark); font-weight: 500;">
                            <i class="fas fa-user"></i> Welcome, {{ user.first_name|default:user.username }}!
                        </span>
                        <a href="{% url 'logout' %}" class="upload-btn" style="background: linear-gradient(135deg, var(--danger-color), #c82333); text-decoration: none; padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" style="background: {% if message.tags == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message.tags == 'success' %}#155724{% else %}#721c24{% endif %}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid {% if message.tags == 'success' %}var(--success-color){% else %}var(--danger-color){% endif %};">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Upload Section -->
        <div class="main-card">
            <div class="card-header">
                <h2><i class="fas fa-upload"></i> Upload ECG Image</h2>
                <p>Upload your ECG image for comprehensive AI-powered analysis</p>
            </div>
            
            <div class="upload-section">
                <form method="post" enctype="multipart/form-data" class="upload-form" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- Patient Details Section -->
                    <div class="patient-details-section">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-user-md"></i> Patient Information
                        </h3>
                        
                        <div class="patient-fields-grid">
                            <div class="field-group">
                                <label for="{{ form.patient_name.id_for_label }}" class="field-label">
                                    <i class="fas fa-user"></i> {{ form.patient_name.label }}
                                </label>
                                {{ form.patient_name }}
                                {% if form.patient_name.errors %}
                                    <div class="field-error">{{ form.patient_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="field-group">
                                <label for="{{ form.patient_age.id_for_label }}" class="field-label">
                                    <i class="fas fa-birthday-cake"></i> {{ form.patient_age.label }}
                                </label>
                                {{ form.patient_age }}
                                {% if form.patient_age.errors %}
                                    <div class="field-error">{{ form.patient_age.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="field-group">
                                <label for="{{ form.patient_dob.id_for_label }}" class="field-label">
                                    <i class="fas fa-calendar-alt"></i> {{ form.patient_dob.label }}
                                </label>
                                {{ form.patient_dob }}
                                {% if form.patient_dob.errors %}
                                    <div class="field-error">{{ form.patient_dob.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="field-group">
                                <label for="{{ form.patient_gender.id_for_label }}" class="field-label">
                                    <i class="fas fa-venus-mars"></i> {{ form.patient_gender.label }}
                                </label>
                                {{ form.patient_gender }}
                                {% if form.patient_gender.errors %}
                                    <div class="field-error">{{ form.patient_gender.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="field-group">
                                <label for="{{ form.patient_phone.id_for_label }}" class="field-label">
                                    <i class="fas fa-phone"></i> {{ form.patient_phone.label }}
                                </label>
                                {{ form.patient_phone }}
                                {% if form.patient_phone.errors %}
                                    <div class="field-error">{{ form.patient_phone.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Upload Section -->
                    <div class="file-upload-section">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">
                            <i class="fas fa-file-medical"></i> ECG Image Upload
                        </h3>
                        
                        <div class="file-input-wrapper">
                            <div class="file-input" id="fileInputArea">
                                <div class="file-input-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="file-input-text">
                                    <strong>Click to upload</strong> or drag and drop<br>
                                    <small>Supports: JPG, PNG, TIFF, PDF</small>

                                </div>
                                {{ form.image }}
                            </div>
                            {% if form.image.errors %}
                                <div class="field-error">{{ form.image.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <button type="submit" class="upload-btn" id="uploadBtn">
                        <i class="fas fa-chart-line"></i> Analyze ECG
                    </button>
                </form>

                <!-- Image Preview -->
                {% if image_url %}
                <div class="image-preview">
                    <h3><i class="fas fa-image"></i> Uploaded ECG</h3>
                    <img src="{{ image_url }}" alt="Uploaded ECG" class="preview-image">
                    <div class="image-info">
                        <i class="fas fa-info-circle"></i> Image uploaded and processed successfully
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Echo Upload Section -->
        {% comment %} <div class="main-card" style="margin-top: 20px;" id="echo-upload">
            <div class="card-header" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                <h2><i class="fas fa-heart"></i> 2D Echocardiogram Analysis</h2>
                <p>Upload echo videos (MP4, AVI, DICOM) for automated cardiac function analysis</p>
            </div>
            <div class="upload-section">
                <form method="post" enctype="multipart/form-data" class="upload-form" onsubmit="showEchoProgress()">
                    {% csrf_token %}
                    
                    <!-- Echo File Upload -->
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-video"></i> Echo Video File</label>
                        <div class="file-upload-wrapper">
                            <input type="file" 
                                   name="echo_file" 
                                   accept=".mp4,.avi,.dcm,.dicom" 
                                   class="file-input" 
                                   id="echoFileInput"
                                   onchange="validateEchoFile(this)"
                                   required>
                            <label for="echoFileInput" class="file-upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span class="upload-text">Choose Echo Video File</span>
                                <small>Supported formats: MP4, AVI, DICOM (.dcm)</small>
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="upload-btn" name="analyze_echo" id="echoUploadBtn">
                        <i class="fas fa-heart"></i> Analyze Echo
                    </button>
                    
                    <!-- Echo Upload Progress -->
                    <div id="echo-upload-progress" style="display: none; margin-top: 15px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #ff6b6b;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="animation: spin 2s linear infinite; color: #ff6b6b; font-size: 24px;">
                                    <i class="fas fa-heart-pulse"></i>
                                </div>
                                <div>
                                    <h4 style="margin: 0; color: #ff6b6b;">Processing Echo Video...</h4>
                                    <p style="margin: 5px 0 0 0; color: #666;">
                                        Analyzing cardiac cycles, detecting views, and calculating ejection fraction
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div> {% endcomment %}

        <!-- Recent Uploads Quick Access (Minimized) -->
        {% if recent_uploads and not result %}
        <div class="main-card" style="margin-top: 20px;">
            <div class="card-header" style="background: linear-gradient(135deg, #6c757d, #5a6268); padding: 15px 30px;">
                <h3 style="font-size: 1.2rem; margin-bottom: 5px;"><i class="fas fa-history"></i> Recent Uploads</h3>
                <p style="font-size: 0.9rem; margin: 0;">Quick access to recently analyzed files</p>
            </div>
            <div class="upload-section" style="padding: 15px 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    {% for recent_file in recent_uploads %}
                    <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 8px; border-left: 3px solid var(--secondary-color); flex: 0 1 auto; min-width: 180px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                            <h6 style="margin: 0; color: var(--primary-color); font-size: 0.8rem; font-weight: 600;">
                                <i class="fas fa-user-md" style="font-size: 0.7rem;"></i>
                                {{ recent_file.patient_name|default:"Unknown Patient"|truncatechars:15 }}
                            </h6>
                            <small style="color: var(--text-light); font-size: 0.7rem;">{{ recent_file.uploaded_at|date:"M d" }}</small>
                        </div>
                        <div style="margin-bottom: 5px; font-size: 0.7rem; color: var(--text-light);">
                            Age: {{ recent_file.patient_age|default:"N/A" }}{% if recent_file.heart_rate %} | {{ recent_file.heart_rate|truncatechars:12 }}{% endif %}
                        </div>
                        <a href="{% url 'file_detail' recent_file.id %}" style="color: var(--secondary-color); text-decoration: none; font-size: 0.75rem;">
                            <i class="fas fa-eye" style="font-size: 0.7rem;"></i> View →
                        </a>
                    </div>
                    {% endfor %}
                    {% if recent_uploads.count >= 5 %}
                    <div style="margin-left: 10px;">
                        <a href="{% url 'uploaded_files' %}" style="color: var(--secondary-color); text-decoration: none; font-size: 0.8rem; padding: 8px 12px; background: #e3f2fd; border-radius: 8px; display: inline-block;">
                            <i class="fas fa-folder-open"></i> View All
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Results Section -->
        {% if result %}
        <div class="results-section" id="results-section">
            {% if result.error %}
                <div class="results-card">
                    <div class="results-header" style="background: linear-gradient(135deg, var(--danger-color), #e74c3c);">
                        <h3><i class="fas fa-exclamation-triangle"></i> Analysis Error</h3>
                    </div>
                    <div class="results-content">
                        <p style="color: var(--danger-color); font-size: 1.1rem;">{{ result.error }}</p>
                    </div>
                </div>
            {% else %}
                <div class="results-card">
                    <div class="results-header">
                        <h3><i class="fas fa-chart-pulse"></i> ECG Analysis Results</h3>
                    </div>
                    
                    <div class="results-content">
                        <!-- Quick Overview -->
                        <div class="analysis-grid">
                            <!-- Heart Rate -->
                            <div class="analysis-item">
                                <h4><i class="fas fa-heartbeat"></i> Heart Rate</h4>
                                <div class="analysis-value">
                                    {% if result.heart_rate.bpm != "Unable to determine" %}
                                        {{ result.heart_rate.bpm }} BPM
                                    {% else %}
                                        {{ result.heart_rate.bpm }}
                                    {% endif %}
                                </div>
                                <div class="analysis-detail">
                                    {% if result.heart_rate.classification != "Unknown" %}
                                        {{ result.heart_rate.classification }}<br>
                                        <small>Confidence: {{ result.heart_rate.confidence }}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Rhythm Analysis -->
                            <div class="analysis-item">
                                <h4><i class="fas fa-wave-square"></i> Rhythm Analysis</h4>
                                <div class="analysis-value">{{ result.rhythm_analysis.primary_rhythm }}</div>
                                <div class="analysis-detail">
                                    Pattern: {{ result.rhythm_analysis.regularity }}<br>
                                    <small>{{ result.rhythm_analysis.notes }}</small>
                                </div>
                            </div>

                            <!-- Technical Details -->
                            {% comment %} <div class="analysis-item">
                                <h4><i class="fas fa-cogs"></i> Technical Details</h4>
                                <div class="analysis-value">{{ result.technical_details.signal_clarity }}</div>
                                <div class="analysis-detail">
                                    Dimensions: {{ result.technical_details.image_dimensions }}<br>
                                    Detected Features: {{ result.technical_details.detected_waves }}
                                </div> {% endcomment %}
                            </div>
                        </div>

                        <!-- Detailed Analysis Tabs -->
                        <div class="findings-section">
                            <div class="findings-tabs">
                                <button class="tab-button active" data-tab="advanced">
                                    <i class="fas fa-microchip"></i> Advanced Analysis
                                </button>
                                <button class="tab-button" data-tab="waves">
                                    <i class="fas fa-chart-line"></i> Wave Analysis
                                </button>
                                <button class="tab-button" data-tab="findings">
                                    <i class="fas fa-search"></i> Clinical Findings
                                </button>
                                <button class="tab-button" data-tab="recommendations">
                                    <i class="fas fa-user-md"></i> Recommendations
                                </button>
                            </div>

                            <!-- Advanced Analysis Tab -->
                            <div class="tab-content active" id="advanced">
                                <h4><i class="fas fa-microchip"></i> Advanced Machine Learning Analysis</h4>
                                
                                <!-- Debug: Show if advanced_analysis exists -->
                                {% if result.advanced_analysis %}
                                    <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 0.9rem; color: #155724;">
                                        <strong>✓ Advanced Analysis Data Available</strong>
                                    </div>
                                {% else %}
                                    <div style="margin-bottom: 15px; padding: 10px; background: #f8d7da; border-radius: 5px; font-size: 0.9rem; color: #721c24;">
                                        <strong>✗ Advanced Analysis Data Missing</strong> - Debug: {{ result|truncatechars:200 }}
                                    </div>
                                {% endif %}
                                
                                <div class="analysis-grid">
                                    <div class="analysis-item">
                                        <h5><i class="fas fa-tachometer-alt"></i> Rate</h5>
                                        <div class="analysis-value" style="font-size: 1.5rem; color: var(--primary-color);">
                                            {{ result.advanced_analysis.rate|default:"75" }}
                                        </div>
                                        <div class="analysis-detail">Ventricular rate</div>
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5><i class="fas fa-wave-square"></i> Rhythm</h5>
                                        <div class="analysis-value" style="color: var(--secondary-color);">
                                            {{ result.advanced_analysis.rhythm|default:"Regular" }}
                                        </div>
                                        <div class="analysis-detail">Rhythm pattern</div>
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5><i class="fas fa-compass"></i> Axis</h5>
                                        <div class="analysis-value">{{ result.advanced_analysis.axis|default:"Normal" }}</div>
                                        <div class="analysis-detail">Electrical axis</div>
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5><i class="fas fa-chart-area"></i> PR/P-wave</h5>
                                        <div class="analysis-value">{{ result.advanced_analysis.pr_p_wave|default:"Normal upright" }}</div>
                                        <div class="analysis-detail">P-wave morphology</div>
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5><i class="fas fa-signal"></i> QRS</h5>
                                        <div class="analysis-value">{{ result.advanced_analysis.qrs|default:"Narrow (90 ms)" }}</div>
                                        <div class="analysis-detail">QRS complex analysis</div>
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5><i class="fas fa-mountain"></i> ST/T wave</h5>
                                        <div class="analysis-value">{{ result.advanced_analysis.st_t_wave|default:"Normal" }}</div>
                                        <div class="analysis-detail">ST segment & T wave</div>
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5><i class="fas fa-clock"></i> QTc/Other</h5>
                                        <div class="analysis-value">{{ result.advanced_analysis.qtc_other|default:"420 ms, Normal" }}</div>
                                        <div class="analysis-detail">Corrected QT interval</div>
                                    </div>
                                    
                                    <div class="analysis-item" style="grid-column: 1 / -1; background: linear-gradient(135deg, #e8f5e8, #f0f9f0); border-left: 4px solid var(--success-color);">
                                        <h5><i class="fas fa-diagnoses"></i> AI Diagnosis</h5>
                                        <div class="analysis-value" style="font-size: 1.2rem; color: var(--success-color); font-weight: 600;">
                                            {{ result.advanced_analysis.diagnosis|default:"ECG Analysis Completed" }}
                                        </div>
                                        <div class="analysis-detail" style="margin-top: 10px;">
                                            <strong>Technical Quality:</strong> {{ result.advanced_analysis.analysis_quality.signal_quality|default:"Good" }}<br>
                                            <strong>Analysis Confidence:</strong> {{ result.advanced_analysis.analysis_quality.confidence|default:"High" }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                    <h5><i class="fas fa-cogs"></i> Technical Analysis Details</h5>
                                    <div class="analysis-grid">
                                        <div class="analysis-item">
                                            <strong>RR Variability:</strong> {{ result.advanced_analysis.technical_analysis.rr_variability|default:"25.0" }} ms
                                        </div>
                                        <div class="analysis-item">
                                            <strong>PR Interval:</strong> {{ result.advanced_analysis.technical_analysis.pr_interval|default:"160.0" }} ms
                                        </div>
                                        <div class="analysis-item">
                                            <strong>QT Interval:</strong> {{ result.advanced_analysis.technical_analysis.qt_interval|default:"420.0" }} ms
                                        </div>
                                        <div class="analysis-item" style="grid-column: 1 / -1;">
                                            <strong>P-wave Morphology Analysis:</strong><br>
                                            Shapes detected: {{ result.advanced_analysis.technical_analysis.p_wave_analysis.shapes|default:"1" }}<br>
                                            Morphology: {{ result.advanced_analysis.technical_analysis.p_wave_analysis.morphology|default:"Normal upright" }}<br>
                                            Variability: {{ result.advanced_analysis.technical_analysis.p_wave_analysis.variability|default:"0.05" }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Wave Morphology Tab -->
                            <div class="tab-content" id="waves">
                                <h4><i class="fas fa-wave-square"></i> Wave Morphology Analysis</h4>
                                
                                <div class="analysis-grid">
                                    <div class="analysis-item">
                                        <h5>P Wave</h5>
                                        <p><strong>Present:</strong> {{ result.wave_morphology.p_wave.present|yesno:"Yes,No" }}</p>
                                        <p><strong>Morphology:</strong> {{ result.wave_morphology.p_wave.morphology }}</p>
                                        <p><strong>Duration:</strong> {{ result.wave_morphology.p_wave.duration }}</p>
                                        {% if result.wave_morphology.p_wave.amplitude %}
                                        <p><strong>Amplitude:</strong> {{ result.wave_morphology.p_wave.amplitude }}</p>
                                        {% endif %}
                                        {% if result.wave_morphology.p_wave.axis %}
                                        <p><strong>Axis:</strong> {{ result.wave_morphology.p_wave.axis }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5>QRS Complex</h5>
                                        <p><strong>Width:</strong> {{ result.wave_morphology.qrs_complex.width }}</p>
                                        <p><strong>Amplitude:</strong> {{ result.wave_morphology.qrs_complex.amplitude }}</p>
                                        <p><strong>Morphology:</strong> {{ result.wave_morphology.qrs_complex.morphology }}</p>
                                        {% if result.wave_morphology.qrs_complex.axis %}
                                        <p><strong>Axis:</strong> {{ result.wave_morphology.qrs_complex.axis }}</p>
                                        {% endif %}
                                        {% if result.wave_morphology.qrs_complex.transition %}
                                        <p><strong>Transition:</strong> {{ result.wave_morphology.qrs_complex.transition }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5>T Wave</h5>
                                        <p><strong>Polarity:</strong> {{ result.wave_morphology.t_wave.polarity }}</p>
                                        <p><strong>Symmetry:</strong> {{ result.wave_morphology.t_wave.symmetry }}</p>
                                        <p><strong>Amplitude:</strong> {{ result.wave_morphology.t_wave.amplitude }}</p>
                                        {% if result.wave_morphology.t_wave.concordance %}
                                        <p><strong>Concordance:</strong> {{ result.wave_morphology.t_wave.concordance }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="analysis-item">
                                        <h5>Intervals</h5>
                                        <p><strong>PR Interval:</strong> {{ result.wave_morphology.intervals.pr_interval }}</p>
                                        <p><strong>QT Interval:</strong> {{ result.wave_morphology.intervals.qt_interval }}</p>
                                        <p><strong>QRS Duration:</strong> {{ result.wave_morphology.intervals.qrs_duration }}</p>
                                        {% if result.wave_morphology.intervals.qtc_interval %}
                                        <p><strong>QTc Interval:</strong> {{ result.wave_morphology.intervals.qtc_interval }}</p>
                                        {% endif %}
                                        {% if result.wave_morphology.intervals.rr_interval %}
                                        <p><strong>RR Interval:</strong> {{ result.wave_morphology.intervals.rr_interval }}</p>
                                        {% endif %}
                                    </div>
                                    
                                    {% if result.wave_morphology.analysis_notes %}
                                    <div class="analysis-item" style="grid-column: 1 / -1;">
                                        <h5>Analysis Notes</h5>
                                        <p><strong>Quality:</strong> {{ result.wave_morphology.analysis_notes.quality }}</p>
                                        <p><strong>Confidence:</strong> {{ result.wave_morphology.analysis_notes.confidence }}</p>
                                        {% if result.wave_morphology.analysis_notes.limitations != "None" %}
                                        <p><strong>Limitations:</strong> {{ result.wave_morphology.analysis_notes.limitations }}</p>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Clinical Findings Tab -->
                            <div class="tab-content" id="findings">
                                <h4><i class="fas fa-stethoscope"></i> Clinical Interpretation</h4>
                                
                                <div style="margin-bottom: 20px;">
                                    <h5>Primary Findings</h5>
                                    <ul class="finding-list">
                                        {% for finding in result.clinical_findings.primary_findings %}
                                        <li>{{ finding }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <h5>Secondary Findings</h5>
                                    <ul class="finding-list">
                                        {% for finding in result.clinical_findings.secondary_findings %}
                                        <li>{{ finding }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="analysis-item" style="background: #e8f5e8; border-left-color: var(--success-color);">
                                    <h5><i class="fas fa-clipboard-check"></i> Overall Impression</h5>
                                    <p style="font-size: 1.1rem; font-weight: 500;">{{ result.clinical_findings.overall_impression }}</p>
                                </div>
                            </div>

                            <!-- Recommendations Tab -->
                            <div class="tab-content" id="recommendations">
                                <h4><i class="fas fa-user-md"></i> Medical Recommendations</h4>
                                
                                <div class="recommendations">
                                    <h5><i class="fas fa-exclamation-circle"></i> Immediate Actions</h5>
                                    <ul class="recommendation-list">
                                        {% for action in result.recommendations.immediate_actions %}
                                        <li>{{ action }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="recommendations" style="background: #fff3cd; border-left-color: var(--warning-color);">
                                    <h5 style="color: var(--warning-color);"><i class="fas fa-calendar-alt"></i> Follow-up Care</h5>
                                    <ul class="recommendation-list">
                                        {% for followup in result.recommendations.follow_up %}
                                        <li>{{ followup }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="recommendations" style="background: #d1ecf1; border-left-color: var(--secondary-color);">
                                    <h5 style="color: var(--secondary-color);"><i class="fas fa-heart"></i> Lifestyle Recommendations</h5>
                                    <ul class="recommendation-list">
                                        {% for lifestyle in result.recommendations.lifestyle %}
                                        <li>{{ lifestyle }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Medical Disclaimer -->
                        <div class="disclaimer">
                            <strong><i class="fas fa-exclamation-triangle"></i> Medical Disclaimer:</strong>
                            {{ result.recommendations.disclaimer }}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Echo Analysis Results Section -->
        {% if echo_result %}
        <div class="results-section" id="echo-results-section">
            {% if echo_result.error %}
                <div class="results-card">
                    <div class="results-header" style="background: linear-gradient(135deg, var(--danger-color), #e74c3c);">
                        <h3><i class="fas fa-exclamation-triangle"></i> Echo Analysis Error</h3>
                    </div>
                    <div class="results-content">
                        <p style="color: var(--danger-color); font-size: 1.1rem;">{{ echo_result.error }}</p>
                    </div>
                </div>
            {% else %}
                <div class="results-card">
                    <div class="results-header" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                        <h3><i class="fas fa-heart"></i> 2D Echo Analysis Results</h3>
                    </div>
                    
                    <div class="results-content">
                        <!-- Success Message -->
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0;"><i class="fas fa-check-circle"></i> Analysis Complete</h4>
                            <p style="margin: 0;">{{ echo_result.summary }}</p>
                        </div>

                        <!-- Ejection Fraction Display -->
                        {% if echo_result.ejection_fraction %}
                        <div class="echo-result-section">
                            <h4><i class="fas fa-heartbeat"></i> Cardiac Function Assessment</h4>
                            
                            <div class="ef-display {{ echo_result.ejection_fraction.css_class }}">
                                Ejection Fraction: {{ echo_result.ejection_fraction.percentage }}%
                            </div>
                            
                            <div class="analysis-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                                <div class="analysis-item">
                                    <h5>Classification</h5>
                                    <p><strong>{{ echo_result.ejection_fraction.classification }}</strong></p>
                                    <p>{{ echo_result.ejection_fraction.interpretation }}</p>
                                </div>
                                
                                {% if echo_result.cardiac_volumes %}
                                <div class="analysis-item">
                                    <h5>Volume Measurements</h5>
                                    <p><strong>End Diastolic Volume:</strong> {{ echo_result.cardiac_volumes.edv_ml }} mL</p>
                                    <p><strong>End Systolic Volume:</strong> {{ echo_result.cardiac_volumes.esv_ml }} mL</p>
                                    <p><strong>Stroke Volume:</strong> {{ echo_result.cardiac_volumes.stroke_volume_ml }} mL</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- View Classification -->
                        {% if echo_result.view_classification %}
                        <div class="echo-result-section">
                            <h4><i class="fas fa-eye"></i> View Classification</h4>
                            <p><strong>Detected View:</strong> {{ echo_result.view_classification.view }}</p>
                            <p><strong>Description:</strong> {{ echo_result.view_classification.description }}</p>
                            
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: {{ echo_result.view_classification.confidence_percent }}%">
                                    {{ echo_result.view_classification.confidence_percent }}% Confidence
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Analysis Quality -->
                        {% if echo_result.analysis_quality %}
                        <div class="echo-result-section">
                            <h4><i class="fas fa-chart-bar"></i> Analysis Quality Assessment</h4>
                            <div class="analysis-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="analysis-item">
                                    <h5>Overall Quality</h5>
                                    <p><strong>{{ echo_result.analysis_quality.quality_grade }}</strong></p>
                                    
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: {{ echo_result.analysis_quality.confidence_percent }}%">
                                            {{ echo_result.analysis_quality.confidence_percent }}%
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="analysis-item">
                                    <h5>Processing Info</h5>
                                    <p><strong>Processing Time:</strong> {{ echo_result.analysis_quality.processing_time_sec }}s</p>
                                    {% if echo_result.analysis_quality.frames_analyzed %}
                                        <p><strong>Frames Analyzed:</strong> {{ echo_result.analysis_quality.frames_analyzed }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Technical Details -->
                        {% if echo_result.technical_details %}
                        <div class="echo-result-section">
                            <h4><i class="fas fa-cog"></i> Technical Details</h4>
                            <div class="analysis-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="analysis-item">
                                    <h5>Video Analysis</h5>
                                    <p><strong>Total Frames:</strong> {{ echo_result.technical_details.frames_processed }}</p>
                                    {% if echo_result.technical_details.frame_rate %}
                                        <p><strong>Frame Rate:</strong> {{ echo_result.technical_details.frame_rate }} FPS</p>
                                    {% endif %}
                                </div>
                                
                                {% if echo_result.technical_details.ed_frame %}
                                <div class="analysis-item">
                                    <h5>Key Frames</h5>
                                    <p><strong>End Diastolic Frame:</strong> {{ echo_result.technical_details.ed_frame }}</p>
                                    <p><strong>End Systolic Frame:</strong> {{ echo_result.technical_details.es_frame }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Clinical Recommendations -->
                        {% if echo_result.recommendations %}
                        <div class="echo-recommendations">
                            <h4><i class="fas fa-user-md"></i> Clinical Recommendations</h4>
                            <ul>
                                {% for recommendation in echo_result.recommendations %}
                                <li>{{ recommendation }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Medical Disclaimer -->
                        <div class="disclaimer" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px;">
                            <strong><i class="fas fa-exclamation-triangle"></i> Medical Disclaimer:</strong>
                            This AI-powered echo analysis is for informational purposes only and should not replace professional medical evaluation. 
                            All results should be reviewed and interpreted by qualified healthcare professionals. 
                            Clinical decisions should not be made based solely on this automated analysis.
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        // Handle browser refresh to clear results
        window.addEventListener('beforeunload', function() {
            // This will be triggered on browser refresh
            // The page will naturally reload without results
        });
        
        // Clear any stored form data on page load to ensure fresh start
        window.addEventListener('load', function() {
            // Check if this is a browser refresh (not a form submission)
            if (performance.navigation.type === performance.navigation.TYPE_RELOAD) {
                // If it's a refresh, redirect to clean home page
                if (window.location.search || window.location.hash) {
                    window.location.href = '{% url "home" %}';
                }
            }
        });
        
        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-scroll to results section if results are present
            const resultsSection = document.getElementById('results-section');
            const echoResultsSection = document.getElementById('echo-results-section');
            
            if (resultsSection) {
                // Small delay to ensure page is fully loaded
                setTimeout(function() {
                    resultsSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start',
                        inline: 'nearest'
                    });
                    
                    // Add a subtle highlight effect
                    resultsSection.style.transition = 'box-shadow 0.3s ease';
                    resultsSection.style.boxShadow = '0 0 20px rgba(76, 175, 80, 0.3)';
                    
                    // Remove highlight after 2 seconds
                    setTimeout(function() {
                        resultsSection.style.boxShadow = '';
                    }, 2000);
                }, 100);
            } else if (echoResultsSection) {
                // Small delay to ensure page is fully loaded
                setTimeout(function() {
                    echoResultsSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start',
                        inline: 'nearest'
                    });
                    
                    // Add a subtle highlight effect with echo colors
                    echoResultsSection.style.transition = 'box-shadow 0.3s ease';
                    echoResultsSection.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.3)';
                    
                    // Remove highlight after 2 seconds
                    setTimeout(function() {
                        echoResultsSection.style.boxShadow = '';
                    }, 2000);
                }, 100);
            }
            
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                });
            });

            // File input enhancement
            const fileInput = document.querySelector('input[type="file"]');
            const fileInputArea = document.getElementById('fileInputArea');
            const fileInputText = document.querySelector('.file-input-text');
            
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const fileName = this.files[0].name;
                        fileInputText.innerHTML = `<strong>Selected:</strong> ${fileName}<br><small>Click "Analyze ECG" to proceed</small>`;
                        fileInputArea.style.borderColor = 'var(--success-color)';
                        fileInputArea.style.background = '#d4edda';
                    }
                });

                // Drag and drop functionality
                fileInputArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = 'var(--primary-color)';
                    this.style.background = '#bbdefb';
                });

                fileInputArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.borderColor = 'var(--secondary-color)';
                    this.style.background = 'var(--light-blue)';
                });

                fileInputArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = 'var(--success-color)';
                    this.style.background = '#d4edda';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        const fileName = files[0].name;
                        fileInputText.innerHTML = `<strong>Selected:</strong> ${fileName}<br><small>Click "Analyze ECG" to proceed</small>`;
                    }
                });
            }

            // Upload button loading state
            const uploadForm = document.getElementById('uploadForm');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (uploadForm && uploadBtn) {
                uploadForm.addEventListener('submit', function() {
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
                    uploadBtn.disabled = true;
                });
            }
            
            // Phone number validation (no formatting)
            const phoneInput = document.querySelector('input[name="patient_phone"]');
            if (phoneInput) {
                // Ensure correct placeholder is set
                phoneInput.placeholder = 'Enter Phone number';
                
                // Keep digits only as user types - no formatting
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, ''); // Remove all non-digits
                    
                    // Limit to 10 digits
                    if (value.length > 10) {
                        value = value.slice(0, 10);
                    }
                    
                    // Set plain digits - no formatting
                    e.target.value = value;
                });
                
                // Validate on blur
                phoneInput.addEventListener('blur', function(e) {
                    const digitsOnly = e.target.value.replace(/\D/g, '');
                    const errorDiv = phoneInput.parentNode.querySelector('.phone-error');
                    
                    // Remove existing error
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                    
                    if (digitsOnly.length > 0 && digitsOnly.length !== 10) {
                        // Add error message
                        const error = document.createElement('div');
                        error.className = 'phone-error field-error';
                        error.style.color = '#dc3545';
                        error.style.fontSize = '0.875rem';
                        error.style.marginTop = '0.25rem';
                        error.textContent = 'Please enter exactly 10 digits';
                        phoneInput.parentNode.appendChild(error);
                        phoneInput.style.borderColor = '#dc3545';
                    } else if (digitsOnly.length === 10 && digitsOnly[0] === '0' || digitsOnly[0] === '1') {
                        // Check for invalid starting digit (area code cannot start with 0 or 1)
                        const error = document.createElement('div');
                        error.className = 'phone-error field-error';
                        error.style.color = '#dc3545';
                        error.style.fontSize = '0.875rem';
                        error.style.marginTop = '0.25rem';
                        error.textContent = 'Area code cannot start with 0 or 1';
                        phoneInput.parentNode.appendChild(error);
                        phoneInput.style.borderColor = '#dc3545';
                    } else if (digitsOnly.length === 10) {
                        phoneInput.style.borderColor = '#28a745'; // Green for valid
                    }
                });
                
                // Clear error styling on focus
                phoneInput.addEventListener('focus', function(e) {
                    const errorDiv = phoneInput.parentNode.querySelector('.phone-error');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                    phoneInput.style.borderColor = '';
                });
            }
        });

        // Echo file validation and upload functions
        function validateEchoFile(input) {
            const file = input.files[0];
            const uploadText = document.querySelector('#echoFileInput + label .upload-text');
            
            if (file) {
                const fileSize = file.size / 1024 / 1024; // Convert to MB
                const fileName = file.name;
                const fileExtension = fileName.split('.').pop().toLowerCase();
                
                // Validate file type
                const allowedTypes = ['mp4', 'avi', 'dcm', 'dicom'];
                if (!allowedTypes.includes(fileExtension)) {
                    alert('Please select a valid echo file (MP4, AVI, or DICOM)');
                    input.value = '';
                    uploadText.textContent = 'Choose Echo Video File';
                    return;
                }
                
                // Validate file size (limit to 500MB)
                if (fileSize > 500) {
                    alert('File size should be less than 500MB');
                    input.value = '';
                    uploadText.textContent = 'Choose Echo Video File';
                    return;
                }
                
                // Update UI to show selected file
                uploadText.innerHTML = `<strong>Selected:</strong> ${fileName} (${fileSize.toFixed(1)}MB)`;
                input.parentElement.parentElement.style.borderColor = '#ff6b6b';
                input.parentElement.parentElement.style.background = '#fff5f5';
            }
        }

        function showEchoProgress() {
            document.getElementById('echo-upload-progress').style.display = 'block';
            document.getElementById('echoUploadBtn').disabled = true;
            document.getElementById('echoUploadBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        }
    </script>
</body>
</html>

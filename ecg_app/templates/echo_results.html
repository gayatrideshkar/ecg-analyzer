<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Analysis Results - {{ echo_image.patient_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .card {
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: none;
        }
        
        .result-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            padding: 2rem;
            text-align: center;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 15px 15px 0 0;
            margin-bottom: 0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 30px;
            font-weight: 600;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
            border-radius: 15px;
            padding: 12px 30px;
            font-weight: 600;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .badge-success { background: linear-gradient(135deg, #00b894 0%, #00a085 100%); }
        .badge-warning { background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%); }
        .badge-danger { background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); }
        .badge-info { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
        
        .progress {
            height: 20px;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
        }
        
        .progress-bar {
            border-radius: 10px;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .finding-item {
            padding: 0.75rem 1rem;
            background: rgba(116, 185, 255, 0.1);
            border-left: 4px solid #74b9ff;
            margin-bottom: 0.5rem;
            border-radius: 0 10px 10px 0;
        }
        
        .technical-detail {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
        }
        
        .ejection-fraction-gauge {
            position: relative;
            width: 200px;
            height: 100px;
            margin: 0 auto 2rem;
        }
        
        .gauge-bg {
            stroke: #e9ecef;
            stroke-width: 20;
        }
        
        .gauge-fill {
            stroke-width: 20;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease-in-out;
        }
        
        .navigation-tabs {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .nav-link {
            border-radius: 10px;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
        }
        
        .nav-link:not(.active) {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.1);">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <i class="fas fa-heartbeat"></i> CardiacAI Pro
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user-circle"></i> Welcome, {{ user.first_name }}
                </span>
                <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Navigation Tabs -->
        <div class="navigation-tabs">
            <ul class="nav nav-pills justify-content-center">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'upload_ecg' %}">
                        <i class="fas fa-chart-line"></i> ECG Analysis
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'upload_echo' %}">
                        <i class="fas fa-heart"></i> Echo Analysis
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'uploaded_files' %}">
                        <i class="fas fa-folder"></i> ECG Files
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active">
                        <i class="fas fa-video"></i> Echo Results
                    </a>
                </li>
            </ul>
        </div>

        <!-- Patient Information Header -->
        <div class="card mb-4">
            <div class="result-header">
                <h2><i class="fas fa-heart me-2"></i>2D Echocardiogram Analysis Results</h2>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <strong>Patient:</strong> {{ echo_image.patient_name }}
                    </div>
                    <div class="col-md-3">
                        <strong>Age:</strong> {{ echo_image.patient_age }} years ({{ echo_image.patient_gender }})
                    </div>
                    <div class="col-md-3">
                        <strong>Analysis Date:</strong> {{ echo_image.analyzed_at|date:"M d, Y" }}
                    </div>
                    <div class="col-md-3">
                        <strong>File:</strong> {{ echo_image.file_name }}
                    </div>
                </div>
            </div>
        </div>

        {% if analysis_data %}
            <!-- Key Metrics Section -->
            <div class="row mb-4">
                {% if analysis_data.cardiac_function %}
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ analysis_data.cardiac_function.ejection_fraction|default:"--" }}%</div>
                            <div class="metric-label">Ejection Fraction</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ analysis_data.cardiac_function.stroke_volume|default:"--" }}</div>
                            <div class="metric-label">Stroke Volume (ml)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ analysis_data.cardiac_function.end_diastolic_volume|default:"--" }}</div>
                            <div class="metric-label">EDV (ml)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">{{ analysis_data.cardiac_function.end_systolic_volume|default:"--" }}</div>
                            <div class="metric-label">ESV (ml)</div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Analysis Results Grid -->
            <div class="analysis-grid">
                <!-- Cardiac Function Card -->
                {% if analysis_data.cardiac_function %}
                <div class="card">
                    <h5 class="section-header">
                        <i class="fas fa-heart-pulse"></i> Cardiac Function Assessment
                    </h5>
                    <div class="card-body">
                        <!-- Ejection Fraction Visualization -->
                        {% if analysis_data.cardiac_function.ejection_fraction %}
                        <div class="ejection-fraction-gauge">
                            <svg viewBox="0 0 200 100">
                                <path class="gauge-bg" d="M 20 80 A 80 80 0 0 1 180 80" fill="none"></path>
                                <path class="gauge-fill" d="M 20 80 A 80 80 0 0 1 180 80" fill="none" 
                                      stroke="{% if analysis_data.cardiac_function.ejection_fraction >= 55 %}#00b894{% elif analysis_data.cardiac_function.ejection_fraction >= 45 %}#fdcb6e{% else %}#e17055{% endif %}"
                                      stroke-dasharray="{{ analysis_data.cardiac_function.ejection_fraction|floatformat:0 }}, 100">
                                </path>
                                <text x="100" y="70" text-anchor="middle" class="h4">{{ analysis_data.cardiac_function.ejection_fraction }}%</text>
                            </svg>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-6">
                                <strong>LV Function:</strong><br>
                                <span class="badge {% if analysis_data.cardiac_function.lv_function_grade == 'Normal' %}badge-success{% elif 'Mild' in analysis_data.cardiac_function.lv_function_grade %}badge-warning{% else %}badge-danger{% endif %}">
                                    {{ analysis_data.cardiac_function.lv_function_grade|default:"Not specified" }}
                                </span>
                            </div>
                            <div class="col-6">
                                <strong>Volumes:</strong><br>
                                EDV: {{ analysis_data.cardiac_function.end_diastolic_volume|default:"--" }} ml<br>
                                ESV: {{ analysis_data.cardiac_function.end_systolic_volume|default:"--" }} ml
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Wall Motion Analysis -->
                {% if analysis_data.wall_motion_analysis %}
                <div class="card">
                    <h5 class="section-header">
                        <i class="fas fa-activity"></i> Wall Motion Analysis
                    </h5>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Overall Assessment:</strong>
                            <span class="badge {% if 'Normal' in analysis_data.wall_motion_analysis.overall_assessment %}badge-success{% elif 'Hypokinetic' in analysis_data.wall_motion_analysis.overall_assessment %}badge-warning{% else %}badge-info{% endif %}">
                                {{ analysis_data.wall_motion_analysis.overall_assessment }}
                            </span>
                        </div>
                        
                        {% if analysis_data.wall_motion_analysis.regional_analysis %}
                        <h6>Regional Analysis:</h6>
                        {% for region, status in analysis_data.wall_motion_analysis.regional_analysis.items %}
                        <div class="finding-item">
                            <strong>{{ region|title }}:</strong> 
                            <span class="badge {% if status == 'Normal' %}badge-success{% else %}badge-warning{% endif %}">{{ status }}</span>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Chamber Analysis -->
                {% if analysis_data.chamber_analysis %}
                <div class="card">
                    <h5 class="section-header">
                        <i class="fas fa-shapes"></i> Chamber Analysis
                    </h5>
                    <div class="card-body">
                        {% if analysis_data.chamber_analysis.left_ventricle %}
                        <h6><i class="fas fa-heart"></i> Left Ventricle:</h6>
                        <div class="technical-detail">
                            <div><strong>Size:</strong> {{ analysis_data.chamber_analysis.left_ventricle.size }}</div>
                            <div><strong>Wall Thickness:</strong> {{ analysis_data.chamber_analysis.left_ventricle.wall_thickness|default:"Not measured" }}</div>
                            <div><strong>Mass:</strong> {{ analysis_data.chamber_analysis.left_ventricle.mass|default:"Not calculated" }}</div>
                        </div>
                        {% endif %}
                        
                        {% if analysis_data.chamber_analysis.left_atrium %}
                        <h6><i class="fas fa-circle"></i> Left Atrium:</h6>
                        <div class="technical-detail">
                            <div><strong>Size:</strong> {{ analysis_data.chamber_analysis.left_atrium.size }}</div>
                            <div><strong>Volume:</strong> {{ analysis_data.chamber_analysis.left_atrium.volume|default:"Not calculated" }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Valve Assessment -->
                {% if analysis_data.valve_assessment %}
                <div class="card">
                    <h5 class="section-header">
                        <i class="fas fa-cog"></i> Valve Assessment
                    </h5>
                    <div class="card-body">
                        {% for valve, status in analysis_data.valve_assessment.items %}
                        <div class="finding-item">
                            <strong>{{ valve|title|replace:'_',' ' }}:</strong> 
                            <span class="badge {% if 'Normal' in status %}badge-success{% elif 'Trace' in status %}badge-info{% else %}badge-warning{% endif %}">{{ status }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Quality Assessment -->
                {% if analysis_data.quality_assessment %}
                <div class="card">
                    <h5 class="section-header">
                        <i class="fas fa-check-circle"></i> Quality Assessment
                    </h5>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Overall Quality:</strong> 
                            <span class="badge badge-info">{{ analysis_data.quality_assessment.overall_quality }}</span>
                        </div>
                        
                        {% if analysis_data.quality_assessment.confidence %}
                        <div class="mb-3">
                            <strong>Confidence Level:</strong>
                            <div class="progress mt-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ analysis_data.quality_assessment.confidence }}%; background: linear-gradient(135deg, #00b894 0%, #00a085 100%);"
                                     aria-valuenow="{{ analysis_data.quality_assessment.confidence }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ analysis_data.quality_assessment.confidence }}%
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="technical-detail">
                            <div><strong>Image Clarity:</strong> {{ analysis_data.quality_assessment.image_clarity|default:"Not assessed" }}</div>
                            <div><strong>Acoustic Windows:</strong> {{ analysis_data.quality_assessment.acoustic_windows|default:"Not assessed" }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Video Analysis Summary -->
                {% if analysis_data.video_analysis %}
                <div class="card">
                    <h5 class="section-header">
                        <i class="fas fa-video"></i> Video Analysis Summary
                    </h5>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div><strong>Total Frames:</strong> {{ analysis_data.video_analysis.total_frames }}</div>
                                <div><strong>Analyzed Frames:</strong> {{ analysis_data.video_analysis.frames_analyzed }}</div>
                            </div>
                            <div class="col-6">
                                <div><strong>Frame Rate:</strong> {{ analysis_data.video_analysis.frame_rate }}</div>
                                <div><strong>Duration:</strong> {{ analysis_data.video_analysis.duration }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Clinical Interpretation -->
            {% if analysis_data.clinical_interpretation %}
            <div class="card mb-4">
                <h5 class="section-header">
                    <i class="fas fa-stethoscope"></i> Clinical Interpretation
                </h5>
                <div class="card-body">
                    {% if analysis_data.clinical_interpretation.summary %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-clipboard-list"></i> Summary:</h6>
                        <p class="mb-0">{{ analysis_data.clinical_interpretation.summary }}</p>
                    </div>
                    {% endif %}

                    {% if analysis_data.clinical_interpretation.findings %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-search"></i> Primary Findings:</h6>
                            {% for finding in analysis_data.clinical_interpretation.findings.primary_findings %}
                            <div class="finding-item">{{ finding }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-list"></i> Secondary Findings:</h6>
                            {% for finding in analysis_data.clinical_interpretation.findings.secondary_findings %}
                            <div class="finding-item">{{ finding }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if analysis_data.clinical_interpretation.recommendations %}
                    <div class="mt-4">
                        <h6><i class="fas fa-prescription"></i> Recommendations:</h6>
                        <ul class="list-group list-group-flush">
                            {% for recommendation in analysis_data.clinical_interpretation.recommendations %}
                            <li class="list-group-item">{{ recommendation }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Technical Details -->
            {% if analysis_data.technical_details %}
            <div class="card mb-4">
                <h5 class="section-header">
                    <i class="fas fa-cogs"></i> Technical Details
                </h5>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div><strong>Analysis Method:</strong> {{ analysis_data.technical_details.analysis_method|default:"Computer Vision Analysis" }}</div>
                            <div><strong>Segmentation Algorithm:</strong> {{ analysis_data.technical_details.segmentation_algorithm|default:"Advanced Edge Detection" }}</div>
                        </div>
                        <div class="col-md-6">
                            <div><strong>Volume Calculation:</strong> {{ analysis_data.technical_details.volume_calculation|default:"Simpson's Method" }}</div>
                            <div><strong>Processing Time:</strong> {{ analysis_data.processing_time|default:"Not recorded" }}</div>
                        </div>
                    </div>
                    {% if analysis_data.technical_details.processing_notes %}
                    <div class="mt-3">
                        <div class="alert alert-secondary">
                            <strong>Processing Notes:</strong> {{ analysis_data.technical_details.processing_notes }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        {% else %}
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>No Analysis Data Available</h4>
                    <p>The analysis results are not available for this echo study.</p>
                    <a href="{% url 'upload_echo' %}" class="btn btn-primary">Upload New Echo</a>
                </div>
            </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="text-center mb-4">
            <a href="{% url 'echo_files_list' %}" class="btn btn-secondary btn-lg me-3">
                <i class="fas fa-list"></i> View All Echo Files
            </a>
            <a href="{% url 'upload_echo' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i> Analyze New Echo
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>